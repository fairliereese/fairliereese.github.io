<!doctype html>

<html class="no-js" lang="en">

<head>


	<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

	Fairlie Reese

	Journal Theme by https://jekyllthemes.io
	Premium + free Jekyll themes for your blog or website.

	- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->


	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<!-- Page Info -->
	<link rel="shortcut icon" href="/images/img/favicon.png">
	<title>Pysam multithreading – Fairlie Reese</title>
	<meta name="description" content="Multithreading sam to bam compression with pysam">

	<!-- Twitter Card -->
	<meta name="twitter:card" content="summary_large_image">
	<meta name="twitter:title" content="Pysam multithreading – Fairlie Reese">
	<meta name="twitter:description" content="Multithreading sam to bam compression with pysam">
	<meta name="twitter:image:src" content="/images/img/binary.png">

	<!-- Facebook OpenGraph -->
	<meta property="og:title" content="Pysam multithreading – Fairlie Reese" />
	<meta property="og:description" content="Multithreading sam to bam compression with pysam" />
	<meta property="og:image" content="/images/img/binary.png" />

	
	<!-- Font Embed Code -->
	<link href="https://fonts.googleapis.com/css?family=Merriweather:300,400|Muli:400,400i,600" rel="stylesheet">
	

	<!-- Styles -->
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="/css/style.css">

	<!-- Icons -->
	<script defer src="https://use.fontawesome.com/releases/v5.1.1/js/solid.js" integrity="sha384-GXi56ipjsBwAe6v5X4xSrVNXGOmpdJYZEEh/0/GqJ3JTHsfDsF8v0YQvZCJYAiGu" crossorigin="anonymous"></script>
	<script defer src="https://use.fontawesome.com/releases/v5.1.1/js/brands.js" integrity="sha384-0inRy4HkP0hJ038ZyfQ4vLl+F4POKbqnaUB6ewmU4dWP0ki8Q27A0VFiVRIpscvL" crossorigin="anonymous"></script>
	<script defer src="https://use.fontawesome.com/releases/v5.1.1/js/fontawesome.js" integrity="sha384-NY6PHjYLP2f+gL3uaVfqUZImmw71ArL9+Roi9o+I4+RBqArA2CfW1sJ1wkABFfPe" crossorigin="anonymous"></script>

	
	<!-- Custom Styles -->
	<style></style>
	

	
	<!-- Analytics Code -->
	
	

	
	<!-- Extra Header JS Code -->
	
	

</head>


<body class="loading ajax-loading" data-site-url="" data-page-url="/blog/pysam-multithreading">


	<header class="header">

	<div class="header-image header-image--on" style="background-image: url(/images/img/binary.png);"></div>
	<div class="header-image"></div>

	<div class="header-overlay"></div>

	<div class="header__content">

		
		<a href="/" class="header__title">
			Fairlie Reese
		</a>
		

		<p class="header__tagline">Bioinformatic analysis · Bioinformatics software/pipeline development · Long-read RNA-seq</p>

		<div class="menu">
			<div class="menu__toggle js-menu-toggle">
				<div class="menu__toggle__icon"><span></span></div>
			</div>
			<div class="menu__wrap">
				<ul class="menu__list">
					
					<li class="menu__list__item">
						<a href="/" class="menu__list__item__link">Blog / Tutorials</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/projects/" class="menu__list__item__link">Projects</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/publications.html" class="menu__list__item__link">Publications</a>
					</li>
					
					<li class="menu__list__item">
						<a href="/about" class="menu__list__item__link">About</a>
					</li>
					
				</ul>
				<ul class="socials">
	
	
	<li class="socials__item">
		
			<a href="https://github.com/fairliereese" target="_blank" class="socials__item__link" title="Github">
				<i class="fab fa-github" aria-hidden="true"></i>
			</a>
		
	</li>
	<!-- console.log(https://github.com/fairliereese) -->
	
	
	
	<li class="socials__item">
		
			<a href="https://orcid.org/0000-0002-9240-0102" target="_blank" class="socials__item__link" title="Orcid">
				<i class="fab fa-orcid" aria-hidden="true"></i>
			</a>
		
	</li>
	<!-- console.log(https://orcid.org/0000-0002-9240-0102) -->
	
	
	
	<li class="socials__item">
		
				<a href="https://scholar.google.com/citations?user=SgA5IcgAAAAJ&hl=en" target="_blank" class="socials__item__link" title="Google Scholar">
					<i class="fas fa-graduation-cap" aria-hidden="true"></i>
				</a>
		
	</li>
	<!-- console.log(https://scholar.google.com/citations?user=SgA5IcgAAAAJ&hl=en) -->
	
	
	
	<li class="socials__item">
		
			<a href="https://twitter.com/FairlieReese" target="_blank" class="socials__item__link" title="Twitter">
				<i class="fab fa-twitter" aria-hidden="true"></i>
			</a>
		
	</li>
	<!-- console.log(https://twitter.com/FairlieReese) -->
	
	
	
	<li class="socials__item">
		
			<a href="https://www.linkedin.com/in/fairlie-reese-a930a5b7/" target="_blank" class="socials__item__link" title="Linkedin">
				<i class="fab fa-linkedin" aria-hidden="true"></i>
			</a>
		
	</li>
	<!-- console.log(https://www.linkedin.com/in/fairlie-reese-a930a5b7/) -->
	
	
</ul>

			</div>
		</div>

	</div>

</header>



	<div class="loader"><svg width="120" height="30" viewBox="0 0 120 30" xmlns="http://www.w3.org/2000/svg"><circle cx="15" cy="15" r="15"><animate attributeName="r" from="15" to="15" begin="0s" dur="0.8s" values="15;9;15" calcMode="linear" repeatCount="indefinite" /><animate attributeName="fill-opacity" from="1" to="1" begin="0s" dur="0.8s" values="1;.5;1" calcMode="linear" repeatCount="indefinite" /></circle><circle cx="60" cy="15" r="9" fill-opacity="0.3"><animate attributeName="r" from="9" to="9" begin="0s" dur="0.8s" values="9;15;9" calcMode="linear" repeatCount="indefinite" /><animate attributeName="fill-opacity" from="0.5" to="0.5" begin="0s" dur="0.8s" values=".5;1;.5" calcMode="linear" repeatCount="indefinite" /></circle><circle cx="105" cy="15" r="15"><animate attributeName="r" from="15" to="15" begin="0s" dur="0.8s" values="15;9;15" calcMode="linear" repeatCount="indefinite" /><animate attributeName="fill-opacity" from="1" to="1" begin="0s" dur="0.8s" values="1;.5;1" calcMode="linear" repeatCount="indefinite" /></circle></svg></div>

	<div class="page-loader"></div>


	<div class="page">

		<div class="page__content" data-page-title="Pysam multithreading – Fairlie Reese" data-image="/images/img/binary.png">

			<section class="intro">

	<div class="wrap">

		<h1>Pysam multithreading</h1>
		<p>14 May 2020</p>

	</div>

</section>

<section class="single">

	<div class="wrap">

		<h2 id="multithreading-pysam-sam-to-bam-conversion">Multithreading pysam SAM to BAM conversion</h2>

<ul>
  <li><a href="https://github.com/fairliereese/blog/tree/main/210514_pysam_multithread">GitHub link</a></li>
</ul>

<p>I recently came across a situation where I needed to use pysam to convert a sam file to a bam file as a part of <a href="https://github.com/mortazavilab/TALON">TALON</a>. As <code class="highlighter-rouge">samtools view</code> contains a multithreading option (<code class="highlighter-rouge">-@ &lt;int&gt;</code>) and pysam enables users to call these samtools commands from Python, I figured I could use <code class="highlighter-rouge">pysam.view()</code> with the <code class="highlighter-rouge">-@</code> option to compress my sam file to a bam file. However even after trying around 5 or 6 different combinations of arguments detailed mainly in <a href="https://github.com/pysam-developers/pysam/issues/677">this pysam issue thread</a>, I was unable to get it to work.</p>

<p>I therefore sought different solutions still within pysam and came across the following threads detailing the need for and subsequent implementation of readers and writers that can employ multithreading: <a href="https://github.com/pysam-developers/pysam/issues/524">here</a>, <a href="https://github.com/pysam-developers/pysam/issues/579">and here</a>, <a href="https://github.com/pysam-developers/pysam/pull/638">and finally here</a>.</p>

<p>So at some point the developers implemented multithreaded file I/O but in my opinion, <a href="https://pysam.readthedocs.io/en/latest/api.html#pysam.AlignmentFile">the pysam documentation</a> still does a rather poor job explaining it. Therefore I used the code detailed in the <a href="https://github.com/pysam-developers/pysam/pull/638">pull request</a> that added multithreaded I/O functionality.</p>

<p>In the following brief tutorial, I show how to compress a sam file into a bam file using pysam using multithreading, demonstrate the speedup gained from running the command on increasing numbers of cores, and show that the contents of the resultant bam file are the same as they would be had we compressed using <code class="highlighter-rouge">samtools view -Sb</code> from the terminal.</p>

<p>First, lets make a “ground truth” bam file using regular <code class="highlighter-rouge">samtools view -Sb</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>samtools view <span class="nt">-Sb</span> c2c12_500k.sam <span class="o">&gt;</span> c2c12_500k.bam
</code></pre></div></div>

<p>Next, we’ll convert from sam -&gt; bam multiple times using different numbers of cores.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pysam</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sam</span> <span class="o">=</span> <span class="s">'c2c12_500k.sam'</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">benchmark_write</span><span class="p">(</span><span class="n">samfile</span><span class="p">,</span> <span class="n">threads</span><span class="p">):</span>
    <span class="n">bamfile</span> <span class="o">=</span> <span class="n">samfile</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s">'_pysam.bam'</span>
    <span class="n">infile</span> <span class="o">=</span> <span class="n">pysam</span><span class="p">.</span><span class="n">AlignmentFile</span><span class="p">(</span><span class="n">samfile</span><span class="p">,</span> <span class="s">'r'</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="n">threads</span><span class="p">)</span>
    <span class="n">outfile</span> <span class="o">=</span> <span class="n">pysam</span><span class="p">.</span><span class="n">AlignmentFile</span><span class="p">(</span><span class="n">bamfile</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'wb'</span><span class="p">,</span>
                                    <span class="n">template</span><span class="o">=</span><span class="n">infile</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="n">threads</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">infile</span><span class="p">:</span>
        <span class="n">outfile</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">17</span><span class="p">)],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'threads'</span><span class="p">])</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">17</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">benchmark_write</span><span class="p">(</span><span class="n">sam</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
        <span class="n">times</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">times</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="s">'threads'</span><span class="p">,</span> <span class="n">value_vars</span><span class="o">=</span><span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)])</span>
<span class="n">df</span><span class="p">.</span><span class="n">rename</span><span class="p">({</span><span class="s">'value'</span><span class="p">:</span><span class="s">'time (seconds)'</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">sns</span><span class="p">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">'threads'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'time (seconds)'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">'pysam_multithread.png'</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="img/pysam_multithread.png" alt="" /></p>

<p>As we can see, even on just ~500k sequences (677 MB), multithreading SAM -&gt; BAM compression provides considerable speedup.</p>

<p>To verify that we the multithreaded version gave us the correct output files, let’s check if the contents of our files are the same. NOTE: samtools operations add additional lines to the file headers so we WON’T be checking the file headers!</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># sort to ensure sequences are in the same order
# convert to sam without the headers
</span><span class="n">pref</span> <span class="o">=</span> <span class="n">sam</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>

<span class="c1"># control - made with `samtools view -Sb sam &gt; bam`
</span><span class="n">infile</span> <span class="o">=</span> <span class="n">pref</span><span class="o">+</span><span class="s">'.bam'</span>
<span class="n">ofile</span> <span class="o">=</span> <span class="n">pref</span><span class="o">+</span><span class="s">'_sorted.bam'</span>
<span class="n">pysam</span><span class="p">.</span><span class="n">sort</span><span class="p">(</span><span class="s">'-o'</span><span class="p">,</span> <span class="n">ofile</span><span class="p">,</span> <span class="n">infile</span><span class="p">)</span>
<span class="n">ofile_sam</span> <span class="o">=</span> <span class="n">pref</span><span class="o">+</span><span class="s">'_sorted.sam'</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ofile_sam</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span>
<span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">pysam</span><span class="p">.</span><span class="n">view</span><span class="p">(</span><span class="s">'-o'</span><span class="p">,</span> <span class="n">ofile_sam</span><span class="p">,</span> <span class="n">ofile</span><span class="p">,</span> <span class="n">save_stdout</span><span class="o">=</span><span class="n">ofile_sam</span><span class="p">)</span>

<span class="c1"># pysam multithreaded bam we just wrote
</span><span class="n">infile</span> <span class="o">=</span> <span class="n">pref</span><span class="o">+</span><span class="s">'_pysam.bam'</span>
<span class="n">ofile</span> <span class="o">=</span> <span class="n">pref</span><span class="o">+</span><span class="s">'_pysam_sorted.bam'</span>
<span class="n">pysam</span><span class="p">.</span><span class="n">sort</span><span class="p">(</span><span class="s">'-o'</span><span class="p">,</span> <span class="n">ofile</span><span class="p">,</span> <span class="n">infile</span><span class="p">)</span>
<span class="n">ofile_sam</span> <span class="o">=</span> <span class="n">pref</span><span class="o">+</span><span class="s">'_pysam_sorted.sam'</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ofile_sam</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span>
<span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">pysam</span><span class="p">.</span><span class="n">view</span><span class="p">(</span><span class="s">'-o'</span><span class="p">,</span> <span class="n">ofile_sam</span><span class="p">,</span> <span class="n">ofile</span><span class="p">,</span> <span class="n">save_stdout</span><span class="o">=</span><span class="n">ofile_sam</span><span class="p">)</span>
</code></pre></div></div>

<p>I tried but I could not figure out a way that worked to easily diff files in python, so use the bash <code class="highlighter-rouge">diff</code> tool to compare the contents of the files.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>diff c2c12_500k_sorted.sam c2c12_500k_pysam_sorted.sam
</code></pre></div></div>

<p>No output, which means the files are the same! To make sure though, we’ll also check the md5sums, which should be identical.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ctrl_md5</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">md5</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">'uhr_min_sorted.sam'</span><span class="p">,</span><span class="s">'rb'</span><span class="p">).</span><span class="n">read</span><span class="p">()).</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="n">pysam_md5</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">md5</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">'uhr_min_pysam_sorted.sam'</span><span class="p">,</span><span class="s">'rb'</span><span class="p">).</span><span class="n">read</span><span class="p">()).</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="n">ctrl_md5</span> <span class="o">==</span> <span class="n">pysam_md5</span><span class="p">)</span>
</code></pre></div></div>
<p>True</p>

<p>The comparison shows that the two are equivalent, so the file contents are identical, and I can now confidently use multithreading to compress sams to bams in pysam.</p>

<p>Tested with pysam version 0.15.4.</p>

<p>References:</p>
<ul>
  <li><a href="https://github.com/pysam-developers/pysam/issues/677">pysam.view() doesn’t output to <code class="highlighter-rouge">-o</code> outfile argument</a></li>
  <li><a href="https://github.com/pysam-developers/pysam/issues/524">Pysam does not support multithreaded compression</a></li>
  <li><a href="https://github.com/pysam-developers/pysam/pull/638">Pull request enabling multithread compression and example of using it</a></li>
  <li><a href="https://github.com/pysam-developers/pysam/issues/579">Pysam does not support multithreaded compression II</a></li>
  <li><a href="https://stackoverflow.com/questions/16874598/how-do-i-calculate-the-md5-checksum-of-a-file-in-python">Calculate md5sum of file in Python</a></li>
  <li><a href="https://stackoverflow.com/questions/1557571/how-do-i-get-time-of-a-python-programs-execution">Time a program’s execution in Python</a></li>
  <li><a href="https://stackoverflow.com/questions/7585307/how-to-correct-typeerror-unicode-objects-must-be-encoded-before-hashing">Proper mode to open file in when computing md5sum in Python</a></li>
</ul>


	</div>

</section>

		</div>

	</div>


	<footer class="footer">

	<div class="footer__copyright">
		<span>© 2025 Fairlie Reese</span>
		<a href="https://jekyllthemes.io" target="_blank">Jekyll Themes</a>
	</div>

</footer>


	<!-- Javascript Assets -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="/js/plugins-min.js"></script>
	<script src="/js/journal-min.js"></script>

	
	<!-- Extra Footer JS Code -->
	
	


</body>

</html>
